# StealthForward 商业授权系统设计蓝图

> **目标**: 构建一套轻量、安全、不仅能控制有效期（月付/年付），还能防止盗版和滥用的软件授权体系 (License System)。

---

## 1. 核心架构 (Architecture)

系统采用典型的 **C/S 验证架构**，引入第三方角色 `Auth Server` (授权中心)。

```mermaid
[ 客户部署端 (Controller) ]              [ 您的云端 (Auth Server) ]
       |                                          |
       |  1. 启动请求 (License + HWID)             |
       | -------------------------------------->  |
       |                                          | 2. 校验逻辑:
       |                                          |    - 激活码是否存在?
       |                                          |    - 是否过期?
       |                                          |    - 机器码(HWID)是否匹配?
       |  3. 返回签名凭证 (Signed JWT)              |
       | <--------------------------------------  |
       |                                          |
       v                                          v
[ 验证通过，正常运行 ]                       [ 记录日志 ]
       |
       |  4. 周期性心跳 (每 6 小时)
       | -------------------------------------->  |
       | <--------------------------------------  |
```

## 2. 安全机制 (Security Design)

为了防止技术型客户破解（如通过修改 hosts 劫持验证域名），我们将采用 **RSA 非对称加密** 技术。

1.  **密钥对生成**：
    *   **私钥 (Private Key)**：保存在您的 `Auth Server` 上，严禁外泄。用于给“授权通过”的指令盖章（签名）。
    *   **公钥 (Public Key)**：硬编码在客户下载的程序里。用于验证那个“章”是不是您盖的。
2.  **防伪造流程**：
    *   即使用户拦截了网络请求，伪造了一个“200 OK”的回复，但因为他没有**私钥**，无法生成正确的**数字签名**。
    *   客户端用内置的**公钥**解密签名失败，程序会判断为盗版并拒绝启动。

## 3. 业务逻辑 (Business Logic)

### 3.1 激活码管理 (License Key)
*   **格式**：`SF-{TYPE}-{RANDOM}` (例如: `SF-YEAR-8A92B3C`)
*   **属性**：
    *   `Type`: 类型 (Monthly, Yearly, Lifetime)
    *   `ExpireAt`: 过期时间
    *   `BindHWID`: 绑定的硬件指纹 (首次激活时自动写入)
    *   `Status`: Active / Banned / Expired

### 3.2 硬件绑定 (Anti-Sharing)
*   **原理**：程序启动时读取服务器的 `MachineID` (Linux `/etc/machine-id` 或网卡 MAC 地址)。
*   **规则**：
    *   首次使用激活码时，服务器记录该 HWID。
    *   后续验证时，如果提交的 HWID 与记录不符，返回 `Error: License already bound to another device`。
    *   **换机策略**：您作为管理员可以在后台手动“重置绑定”，允许客户换服务器。

### 3.3 过期处理 (Expiration)
*   **宽限期 (Grace Period)**：考虑到网络波动，允许 24 小时的宽限期。
*   **动作**：
    *   **Warning**：过期前 3 天，Web 面板顶部显示续费提示。
    *   **Stop**：过期且超过宽限期，面板变为由“只读模式”或直接停止转发服务 API。

## 4. 开发路线图 (Roadmap)

### 第一阶段：搭建授权服务端 (Auth Server)
*   [ ] 基于 Go/Gin 开发简单的 API 服务。
*   [ ] 使用 SQLite 存储授权数据。
*   [ ] 实现 RSA 签名接口。
*   [ ] 提供一个简易的 Web 后台，供您生成/管理激活码。

### 第二阶段：客户端改造 (Client Integration)
*   [ ] 在 `StealthForward Controller` 启动流程中插入验证中间件。
*   [ ] 实现 HWID 获取逻辑。
*   [ ] 嵌入 Public Key 进行验签。
*   [ ] 增加“未授权”状态下的功能锁（禁止添加节点、禁止保存配置）。

### 第三阶段：自动化对接 (可选)
*   [ ] 对接发卡网或支付网关（USDT/支付宝）。
*   [ ] 支付成功后自动生成 Key 并发送邮件。

---

*这份蓝图已归档，未来准备商业化时可直接按此实施。*
