<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>StealthForward | 隐形转发中控中心</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <link
        href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;600&family=Noto+Sans+SC:wght@400;700&display=swap"
        rel="stylesheet">
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        slate: { 850: '#151e2e' }
                    }
                }
            }
        }
    </script>
    <style>
        /* [v-cloak] { display: none !important; }  Remove strict hiding for debug */
        :root {
            --accent: #6366f1;
            --accent-glow: rgba(99, 102, 241, 0.4);
        }

        body {
            font-family: 'Outfit', 'Noto Sans SC', sans-serif;
            background: radial-gradient(circle at 50% 0%, #0f172a 0%, #020617 100%);
            color: #f8fafc;
            min-height: 100vh;
        }

        .glass {
            background: #1e293b;
            /* 使用固体深色，放弃透明模糊，确保绝对流畅和清晰 */
            border: 1px solid rgba(255, 255, 255, 0.1);
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.5);
        }

        .accent-border {
            border-left: 4px solid var(--accent);
        }

        .gradient-text {
            background: linear-gradient(135deg, #818cf8 0%, #c084fc 100%);
            -webkit-background-clip: text;
            background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        @keyframes fade-in {
            from {
                opacity: 0;
            }

            to {
                opacity: 1;
            }
        }

        @keyframes slide-up {
            from {
                transform: translateY(20px);
                opacity: 0;
            }

            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        .animate-in {
            animation: fade-in 0.5s ease-out forwards;
        }

        .animate-slide-up {
            animation: slide-up 0.5s ease-out forwards;
        }

        .custom-scrollbar::-webkit-scrollbar {
            width: 4px;
        }

        .custom-scrollbar::-webkit-scrollbar-track {
            background: rgba(0, 0, 0, 0.1);
        }

        .custom-scrollbar::-webkit-scrollbar-thumb {
            background: rgba(99, 102, 241, 0.2);
            border-radius: 10px;
        }

        input,
        select {
            background: #0f172a;
            /* 固体背景，防止在某些浏览器下透出底色导致文字模糊 */
            border: 1px solid #334155;
            border-radius: 8px;
            padding: 10px;
            color: #f8fafc;
        }

        /* 修复下拉框选项在部分浏览器不可见的问题 */
        option {
            background-color: #1e293b;
            color: #f8fafc;
        }

        input:focus {
            border-color: var(--accent);
            outline: none;
            box-shadow: 0 0 10px var(--accent-glow);
        }

        .tab-btn {
            padding: 8px 20px;
            border-radius: 12px;
            transition: all 0.2s;
            cursor: pointer;
            border: 1px solid transparent;
        }

        .tab-btn.active {
            background: rgba(99, 102, 241, 0.1);
            border-color: rgba(99, 102, 241, 0.3);
            color: var(--accent);
            font-weight: 600;
        }
    </style>
</head>

<body class="p-4 md:p-8 custom-scrollbar">
    <div id="app" class="max-w-7xl mx-auto v-cloak">
        <!-- Header Section -->
        <div class="flex flex-col md:flex-row justify-between items-start md:items-center mb-8 gap-4">
            <div>
                <h1 class="text-4xl font-extrabold tracking-tighter gradient-text">StealthForward v2.0</h1>
                <p class="text-slate-500 text-sm mt-1">First-Principles 架构 | 隐形中转分流中心</p>
            </div>
            <div class="flex gap-3">
                <div class="glass flex p-1 rounded-2xl items-center">
                    <div @click="activeTab = 'dashboard'"
                        :class="['tab-btn', activeTab === 'dashboard' ? 'active' : '']">概览</div>
                    <div @click="activeTab = 'mappings'" :class="['tab-btn', activeTab === 'mappings' ? 'active' : '']">
                        配置</div>
                    <div @click="activeTab = 'settings'" :class="['tab-btn', activeTab === 'settings' ? 'active' : '']">
                        系统</div>
                </div>
                <button @click="fetchData"
                    class="p-3 px-5 glass rounded-2xl hover:bg-slate-800/50 transition flex items-center gap-2">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path
                            d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15">
                        </path>
                    </svg>
                    刷新
                </button>
                <button @click="logout"
                    class="p-3 px-5 glass rounded-2xl hover:bg-slate-800/50 transition flex items-center gap-2 text-red-400">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path
                            d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1">
                        </path>
                    </svg>
                    退出
                </button>
            </div>
        </div>

        <!-- Stats Overview Row -->
        <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-8">
            <div class="glass p-5 rounded-3xl border-t border-white/5">
                <div class="text-slate-500 text-xs mb-1 uppercase tracking-widest font-bold">入口节点</div>
                <div class="text-3xl font-light">{{ entries.length }} <span
                        class="text-xs text-indigo-400 font-normal">Active</span></div>
            </div>
            <div class="glass p-5 rounded-3xl border-t border-white/5">
                <div class="text-slate-500 text-xs mb-1 uppercase tracking-widest font-bold">分流出口</div>
                <div class="text-3xl font-light">{{ exits.length }} <span
                        class="text-xs text-emerald-400 font-normal">Nodes</span></div>
            </div>
            <div class="glass p-5 rounded-3xl border-t border-white/5">
                <div class="text-slate-500 text-xs mb-1 uppercase tracking-widest font-bold">映射规则</div>
                <div class="text-3xl font-light text-indigo-400">{{ mappings.length }} <span
                        class="text-xs text-slate-500 font-normal">Fixed</span></div>
            </div>
            <div class="glass p-5 rounded-3xl border-indigo-500/20 border-t pulse cursor-pointer hover:bg-indigo-500/5 transition"
                @click="showDashboard = !showDashboard">
                <div
                    class="text-indigo-400 text-xs mb-1 uppercase tracking-widest font-bold flex justify-between items-center">
                    <span>总链路数</span>
                    <span class="text-[8px] border border-indigo-500/30 px-1 rounded">{{ showDashboard ? '点击折叠看板' :
                        '点击展开看板' }}</span>
                </div>
                <div class="text-3xl font-light text-white">{{ rules.length + mappings.length }}</div>
            </div>
        </div>

        <!-- Main Content Area -->
        <div v-show="activeTab === 'dashboard'"
            class="grid grid-cols-1 lg:grid-cols-4 gap-8 animate-in fade-in duration-500">
            <!-- Entry Node List (Expanded if dashboard hidden) -->
            <div :class="showDashboard ? 'lg:col-span-3' : 'lg:col-span-4'" class="space-y-6">
                <div class="flex justify-between items-center px-2">
                    <h2 class="text-xl font-bold flex items-center gap-2">
                        <span class="w-2 h-2 bg-indigo-500 rounded-full animate-pulse"></span>
                        入站入口 (Entry)
                    </h2>
                    <div class="flex gap-3">
                        <button @click="showProvisionModal"
                            class="text-sm font-bold text-transparent bg-clip-text bg-gradient-to-r from-amber-400 to-orange-500 hover:scale-105 transition flex items-center gap-1">
                            <svg class="w-4 h-4 text-amber-500" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M13 10V3L4 14h7v7l9-11h-7z" />
                            </svg>
                            新建云端节点
                        </button>
                        <button @click="addEntry" class="text-sm text-indigo-400 hover:underline">+ 手动新增</button>
                    </div>
                </div>
                <div class="grid grid-cols-1 gap-4">
                    <div v-for="node in entries" :key="node.id"
                        class="glass p-6 rounded-[2.5rem] relative overflow-hidden group">
                        <div
                            class="absolute top-0 right-0 p-4 opacity-5 group-hover:opacity-10 transition pointer-events-none">
                            <svg class="w-24 h-24" fill="currentColor" viewBox="0 0 20 20">
                                <path d="M2 10a8 8 0 018-8v8h8a8 8 0 11-16 0z"></path>
                            </svg>
                        </div>
                        <div class="flex justify-between items-start">
                            <div class="flex-1">
                                <div class="flex items-center gap-3">
                                    <h3 class="text-xl font-bold">{{ node.name }}</h3>
                                    <span
                                        class="px-2 py-0.5 rounded-full bg-indigo-500/10 text-indigo-400 text-[10px] font-bold">ID
                                        #{{node.id}}</span>
                                    <!-- 证书状态标识 -->
                                    <span v-if="node.cert_task"
                                        class="flex items-center gap-1 text-[10px] text-blue-400 bg-blue-500/10 px-2 py-0.5 rounded-full animate-pulse">
                                        <svg class="w-3 h-3 animate-spin" fill="none" viewBox="0 0 24 24"
                                            stroke="currentColor">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                                d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15">
                                            </path>
                                        </svg>
                                        中转机申请中...
                                    </span>
                                    <span v-else-if="node.cert_body"
                                        class="flex items-center gap-1 text-[10px] text-emerald-400 bg-emerald-500/10 px-2 py-0.5 rounded-full">
                                        <svg class="w-3 h-3" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                                d="M5 13l4 4L19 7"></path>
                                        </svg>
                                        证书已生效 (云端备份)
                                    </span>
                                </div>
                                <div class="font-mono text-slate-500 text-sm mt-1">{{ node.domain }} <span
                                        class="text-slate-700 mx-2">|</span> {{ node.port }}</div>
                                <!-- 节点标签展示 -->
                                <div class="flex gap-2 mt-4">
                                    <div class="p-2 px-3 bg-slate-800/80 rounded-xl border border-white/5 text-[10px]">
                                        <div class="text-slate-500 mb-0.5 uppercase tracking-tighter">默认落地</div> {{
                                        findNodeName('exits', node.target_exit_id) || '不绑定' }}
                                    </div>
                                    <div class="p-2 px-3 bg-slate-800/80 rounded-xl border border-white/5 text-[10px]">
                                        <div class="text-slate-500 mb-0.5 uppercase tracking-tighter">API 同步</div> {{
                                        node.v2board_url ? '已开启' : '未开启' }}
                                    </div>
                                    <div
                                        class="p-2 px-3 bg-indigo-500/10 rounded-xl border border-indigo-500/20 text-[10px] min-w-[80px]">
                                        <div class="text-indigo-400 mb-0.5 uppercase tracking-tighter font-bold">已用流量
                                        </div>
                                        <span class="text-white font-mono">{{ formatBytes(getEntryTraffic(node.id))
                                            }}</span>
                                    </div>
                                </div>
                            </div>
                            <div class="flex flex-col gap-2 relative z-10">
                                <button @click="editEntry(node)"
                                    class="p-3 glass rounded-2xl text-indigo-400 hover:scale-110 active:scale-95 transition cursor-pointer"><svg
                                        class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                            d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z">
                                        </path>
                                    </svg></button>
                                <!-- Rotate IP Button -->
                                <button @click="showRotateModal(node)" :title="'Auto Heal / Rotate IP'"
                                    class="p-3 glass rounded-2xl text-amber-500 hover:scale-110 active:scale-95 transition cursor-pointer">
                                    <svg class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                            d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" />
                                    </svg>
                                </button>
                                <button @click="deleteItem('entries', node.id)"
                                    class="p-3 glass rounded-2xl text-rose-500 hover:scale-110 active:scale-95 transition cursor-pointer"><svg
                                        class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                            d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16">
                                        </path>
                                    </svg></button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Dashboard Task/Rules List (Narrow Sidebar) -->
            <div v-if="showDashboard" class="lg:col-span-1 space-y-6 animate-in slide-in-from-right-8 duration-300">
                <!-- ... existing dashboard code ... -->

                <div class="flex justify-between items-center px-2">
                    <h2 class="text-xl font-bold flex items-center gap-2">任务看板</h2>
                    <button @click="addRule" class="text-xs text-indigo-400 transition">+ 用户转发</button>
                </div>
                <div class="glass p-1 rounded-3xl overflow-hidden min-h-[400px]">
                    <div class="max-h-[700px] overflow-y-auto custom-scrollbar p-3 space-y-3">
                        <div v-for="rule in rules" :key="rule.id"
                            class="p-2 px-3 bg-slate-800/40 border border-white/5 rounded-xl flex justify-between items-center transition group hover:bg-slate-800/80">
                            <div class="min-w-0 flex-1">
                                <div class="text-[11px] font-bold truncate text-slate-300">{{ rule.user_email }}</div>
                                <div class="text-[9px] text-slate-500 mt-0.5 flex items-center gap-1">
                                    <span class="text-indigo-400/80">E#{{ rule.entry_node_id }}</span>
                                    <span class="text-slate-700">→</span>
                                    <span class="text-emerald-400/80">X#{{ rule.exit_node_id }}</span>
                                </div>
                            </div>
                            <button @click="deleteItem('rules', rule.id)"
                                class="opacity-0 group-hover:opacity-100 p-1.5 text-rose-400 hover:scale-110 transition">
                                <svg class="w-3.5 h-3.5" fill="currentColor" viewBox="0 0 20 20">
                                    <path
                                        d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z">
                                    </path>
                                </svg>
                            </button>
                        </div>
                        <div v-if="rules.length === 0"
                            class="flex flex-col items-center justify-center pt-20 text-slate-600">
                            <div class="text-sm">暂无手动规则</div>
                            <div class="text-[10px]">所有用户可能由映射关系自动化处理</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Exit Node Section (Wide) -->
            <div class="lg:col-span-4 space-y-6">
                <div class="flex justify-between items-center px-2">
                    <h2 class="text-xl font-bold flex items-center gap-2">分流落地 (Exit / Nodes)</h2>
                    <button @click="addExit" class="text-sm text-emerald-400 hover:underline">+ 新增</button>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
                    <div v-for="node in exits" :key="node.id"
                        class="bg-slate-800/60 p-5 rounded-3xl group border-l-4 border-emerald-500/30 shadow-lg">
                        <div class="flex justify-between items-start mb-3">
                            <div>
                                <div class="font-bold flex items-center gap-2">{{ node.name }} <span
                                        class="bg-emerald-500/10 text-emerald-400 text-[8px] p-1 px-1.5 rounded uppercase">{{node.protocol}}</span>
                                </div>
                                <div class="text-[10px] text-slate-500 mt-1 font-mono truncate w-32">{{ node.address
                                    }}:{{ node.port }}</div>
                            </div>
                            <div class="flex gap-1 opacity-0 group-hover:opacity-100 transition relative z-10">
                                <button @click="editExit(node)"
                                    class="p-1.5 glass rounded-lg text-emerald-400 hover:scale-110 cursor-pointer"><svg
                                        class="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path
                                            d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z">
                                        </path>
                                    </svg></button>
                                <button @click="deleteItem('exits', node.id)"
                                    class="p-1.5 glass rounded-lg text-rose-500 hover:scale-110 cursor-pointer"><svg
                                        class="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path
                                            d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16">
                                        </path>
                                    </svg></button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Intelligent Mapping View -->
        <div v-show="activeTab === 'mappings'" class="space-y-6 animate-in slide-in-from-bottom-4 duration-500">
            <div class="glass p-8 rounded-[3rem] border-indigo-500/10">
                <div class="flex justify-between items-center mb-8">
                    <div>
                        <h2 class="text-2xl font-bold">多目标分流策略 (Routing Policy)</h2>
                        <p class="text-slate-500 text-sm">单入口 443 转发上百节点的“心脏” | 根据节点 ID 动态流转</p>
                    </div>
                    <button @click="addMapping"
                        class="accent-gradient p-3 px-8 rounded-full text-sm font-bold shadow-lg shadow-indigo-500/20 active:scale-95 transition">添加分流规则</button>
                </div>

                <div class="overflow-hidden rounded-2xl border border-white/5">
                    <table class="w-full text-left border-collapse">
                        <thead class="bg-slate-800/50 text-slate-400 text-xs uppercase tracking-wider font-semibold">
                            <tr>
                                <th class="py-4 px-6">来源入口 (Entry)</th>
                                <th class="py-4 px-6">V2B 节点 ID</th>
                                <th class="py-4 px-6">目标分流 (Exit)</th>
                                <th class="py-4 px-6">监听端口</th>
                                <th class="py-4 px-6">状态</th>
                                <th class="py-4 px-6 text-right">操作</th>
                            </tr>
                        </thead>
                        <tbody class="text-sm divide-y divide-white/5 bg-slate-800/20">
                            <tr v-for="m in mappings" :key="m.id" class="hover:bg-indigo-500/5 transition group">
                                <td class="py-4 px-6 font-medium text-slate-200">
                                    <div class="flex flex-col">
                                        <span>{{ findNodeName('entries', m.entry_node_id) }}</span>
                                        <span class="text-[10px] text-slate-500">Entry #{{ m.entry_node_id }}</span>
                                    </div>
                                </td>
                                <td class="py-4 px-6">
                                    <span
                                        class="inline-flex items-center px-2.5 py-1 rounded-md bg-slate-700/50 text-indigo-300 text-xs font-mono border border-indigo-500/20">
                                        Node {{ m.v2board_node_id }}
                                    </span>
                                </td>
                                <td class="py-4 px-6">
                                    <div class="flex items-center gap-2">
                                        <div class="w-2 h-2 rounded-full bg-emerald-500"></div>
                                        <span class="text-emerald-300">{{ findNodeName('exits', m.target_exit_id)
                                            }}</span>
                                    </div>
                                </td>
                                <td class="py-4 px-6">
                                    <span v-if="m.port > 0"
                                        class="font-mono text-amber-300 bg-amber-500/10 px-2 py-1 rounded border border-amber-500/20">{{
                                        m.port }}</span>
                                    <span v-else class="text-slate-500 text-xs italic">跟随入口默认</span>
                                </td>
                                <td class="py-4 px-6">
                                    <span class="inline-flex items-center gap-1.5 text-xs text-slate-400">
                                        <span class="w-1.5 h-1.5 bg-green-500 rounded-full animate-pulse"></span>
                                        运行中
                                    </span>
                                    <div class="mt-1 text-[10px] text-slate-500 font-mono">
                                        流量: <span class="text-slate-300">{{
                                            formatBytes(getMappingTraffic(m.entry_node_id, m.v2board_node_id)) }}</span>
                                    </div>
                                </td>
                                <td class="py-4 px-6 text-right">
                                    <div
                                        class="flex justify-end gap-2 opacity-0 group-hover:opacity-100 transition duration-200">
                                        <button @click="editMapping(m)"
                                            class="p-2 bg-indigo-500/10 text-indigo-400 rounded-lg hover:bg-indigo-500 hover:text-white transition"
                                            title="编辑端口/规则">
                                            <svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                                    d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z" />
                                            </svg>
                                        </button>
                                        <button @click="deleteItem('mappings', m.id)"
                                            class="p-2 bg-rose-500/10 text-rose-500 rounded-lg hover:bg-rose-500 hover:text-white transition"
                                            title="删除规则">
                                            <svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                                    d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                                            </svg>
                                        </button>
                                    </div>
                                </td>
                            </tr>
                            <tr v-if="mappings.length === 0">
                                <td colspan="6" class="py-12 text-center text-slate-500 italic">
                                    暂无分流策略，所有流量将默认转发至入口绑定的落地机。
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- System Settings View -->
        <div v-show="activeTab === 'settings'" class="max-w-4xl mx-auto space-y-6 animate-in fade-in duration-500">
            <div class="glass p-8 rounded-[3rem]">
                <h2 class="text-2xl font-bold mb-6 flex items-center gap-2">
                    <svg class="w-6 h-6 text-indigo-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z">
                        </path>
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path>
                    </svg>
                    全局资源配置 (Infrastructure)
                </h2>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div class="space-y-4">
                        <h3 class="text-lg font-bold text-slate-400 border-b border-white/5 pb-2">AWS
                            Credentials</h3>
                        <label class="block text-sm text-slate-500">Access Key ID
                            <input v-model="settings['aws.access_key_id']" class="w-full mt-1" placeholder="AKIA...">
                        </label>
                        <label class="block text-sm text-slate-500">Secret Access Key
                            <input v-model="settings['aws.secret_access_key']" type="password" class="w-full mt-1"
                                placeholder="wJalrX...">
                        </label>
                        <label class="block text-sm text-slate-500">Default Region
                            <select v-model="settings['aws.default_region']" class="w-full mt-1">
                                <option value="ap-northeast-1">Tokyo (ap-northeast-1)</option>
                                <option value="ap-east-1">Hong Kong (ap-east-1)</option>
                                <option value="ap-southeast-1">Singapore (ap-southeast-1)</option>
                                <option value="us-west-1">California (us-west-1)</option>
                            </select>
                        </label>
                    </div>
                    <div class="space-y-4">
                        <h3 class="text-lg font-bold text-slate-400 border-b border-white/5 pb-2">Cloudflare DNS
                        </h3>
                        <label class="block text-sm text-slate-500">API Token (Edit Zone DNS)
                            <input v-model="settings['cloudflare.api_token']" type="password" class="w-full mt-1"
                                placeholder="X-Auth-Key...">
                        </label>
                        <label class="block text-sm text-slate-500">Default Zone (e.g. 2233006.xyz)
                            <input v-model="settings['cloudflare.default_zone']" class="w-full mt-1"
                                placeholder="example.com">
                        </label>
                    </div>
                </div>
                <div class="mt-8 flex justify-end">
                    <button @click="saveSettings"
                        class="bg-indigo-600 hover:bg-indigo-500 text-white px-8 py-3 rounded-xl font-bold transition shadow-lg shadow-indigo-500/20 active:scale-95">
                        保存系统配置
                    </button>
                </div>
            </div>
        </div>

        <!-- Login / Auth Modal (Full Screen) -->
        <div v-if="!isAuthenticated"
            class="fixed inset-0 bg-[#020617] z-[100] flex items-center justify-center p-4 animate-in fade-in duration-500">
            <div class="w-full max-w-md space-y-8">
                <div class="text-center">
                    <h1 class="text-5xl font-extrabold tracking-tighter gradient-text mb-2">StealthForward</h1>
                    <p class="text-slate-500">Restricted Access Control System</p>
                </div>
                <div class="glass p-8 rounded-[2rem] space-y-6">
                    <div>
                        <label class="text-xs font-bold text-slate-500 uppercase tracking-widest pl-1">Admin
                            Password</label>
                        <input type="password" v-model="loginPassword" @keyup.enter="performLogin"
                            class="w-full mt-2 bg-slate-900/50 border-slate-700 focus:border-indigo-500 transition p-4 rounded-xl text-lg text-center tracking-widest"
                            placeholder="••••••••••••" autofocus>
                    </div>
                    <button @click="performLogin"
                        class="w-full bg-indigo-600 hover:bg-indigo-500 text-white p-4 rounded-xl font-bold transition shadow-lg shadow-indigo-500/20 active:scale-95 mb-2">
                        UNLOCK CONSOLE
                    </button>
                    <p v-if="loginError" class="text-center text-rose-500 text-sm animate-pulse">{{ loginError
                        }}</p>
                </div>
            </div>
        </div>


        <!-- Modal System -->
        <!-- Add/Edit Entry Modal -->
        <div v-if="modal.type === 'entry'"
            class="fixed inset-0 bg-black/80 backdrop-blur-sm z-50 flex items-center justify-center p-4">
            <div class="glass w-full max-w-xl p-8 rounded-[3rem] animate-in zoom-in-95 duration-300">
                <h3 class="text-2xl font-bold mb-6">入站节点配置</h3>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 text-sm">
                    <label class="md:col-span-2 flex flex-col gap-1.5 text-slate-500">显示名称<input
                            v-model="form.entry.name" placeholder="美国 01 / 日本入口"></label>
                    <label class="flex flex-col gap-1.5 text-slate-500">解析域名 (TLS)<input v-model="form.entry.domain"
                            placeholder="example.com"></label>
                    <label class="flex flex-col gap-1.5 text-slate-500">监听端口<input type="number"
                            v-model.number="form.entry.port" placeholder="443"></label>
                    <div class="md:col-span-2">
                        <!-- 只有已保存的节点(有 ID)才允许申请证书 -->
                        <button v-if="form.entry.id" @click="requestCert"
                            :disabled="certLoading || form.entry.cert_task"
                            class="w-full p-3 glass text-indigo-400 text-xs rounded-xl border border-indigo-500/20 active:scale-95 transition disabled:opacity-50">
                            <span v-if="form.entry.cert_task">⏳ 中转机正在申请中...</span>
                            <span v-else-if="certLoading">正在下发指令...</span>
                            <span v-else>一键申请部署域名证书</span>
                        </button>
                        <!-- 新节点提示保存 -->
                        <div v-else
                            class="w-full p-3 bg-slate-800/50 text-slate-500 text-[10px] text-center rounded-xl border border-dashed border-white/10 uppercase tracking-widest">
                            请先保存节点以激活「一键签发证书」功能
                        </div>
                    </div>
                    <label class="flex flex-col gap-1.5 text-slate-500">证书路径<input v-model="form.entry.certificate"
                            placeholder="/etc/stealthforward/certs/cert.crt"></label>
                    <label class="flex flex-col gap-1.5 text-slate-500">私钥路径<input v-model="form.entry.key"
                            placeholder="/etc/stealthforward/certs/cert.key"></label>
                    <label class="md:col-span-2 flex flex-col gap-1.5 text-slate-500">回落托管 (HTTP)<input
                            v-model="form.entry.fallback" placeholder="127.0.0.1:80"></label>
                    <label class="md:col-span-2 flex flex-col gap-1.5 text-slate-500 text-indigo-400 font-bold">V2Board
                        API 同步 (可选)</label>
                    <input class="md:col-span-2" v-model="form.entry.v2board_url"
                        placeholder="API 地址: https://v2.mysite.com">
                    <input v-model="form.entry.v2board_key" type="password" placeholder="通讯令牌 (Key)">
                    <div class="grid grid-cols-2 gap-2">
                        <input type="number" v-model.number="form.entry.v2board_node_id" placeholder="默认节点ID">
                        <select v-model="form.entry.v2board_type">
                            <option value="v2ray">V2ray</option>
                            <option value="vless">VLESS</option>
                            <option value="shadowsocks">Shadowsocks</option>
                            <option value="anytls">AnyTLS</option>
                        </select>
                    </div>
                    <label class="md:col-span-2 flex flex-col gap-1.5 text-slate-500 text-indigo-400 font-bold">目标落地机
                        (流量转发目的地)</label>
                    <select class="md:col-span-2" v-model.number="form.entry.target_exit_id">
                        <option :value="0">不绑定 (所有用户将无法连接)</option>
                        <option v-for="ex in exits" :key="ex.id" :value="ex.id">{{ ex.name }} — 发往此机器</option>
                    </select>
                </div>
                <div class="flex gap-4 mt-8">
                    <button @click="hideModal" class="flex-1 p-4 bg-slate-800 rounded-2xl">取消</button>
                    <button @click="submitEntry" class="flex-1 p-4 bg-indigo-600 rounded-2xl font-bold">保存节点</button>
                </div>
            </div>
        </div>

        <!-- Rotate IP Modal -->
        <div v-if="modal.type === 'rotate'"
            class="fixed inset-0 bg-black/80 backdrop-blur-sm z-50 flex items-center justify-center p-4">
            <div class="glass w-full max-w-md p-8 rounded-[3rem] animate-in zoom-in-95 duration-200">
                <div class="mb-6">
                    <h3 class="text-2xl font-bold text-amber-500 mb-2">Auto Heal / 自动换IP</h3>
                    <p class="text-xs text-slate-500">此操作将申请新的 AWS EIP 并绑定到实例，同时更新 Cloudflare DNS。业务可能会中断 1-2
                        分钟。</p>
                </div>
                <div class="space-y-4 text-sm">
                    <label class="flex flex-col gap-1.5 text-slate-500">AWS Region
                        <input v-model="form.rotate.region" placeholder="ap-northeast-1">
                    </label>
                    <label class="flex flex-col gap-1.5 text-slate-500">Instance ID
                        <input v-model="form.rotate.instance_id" placeholder="i-0123456789abcdef0">
                    </label>
                    <label class="flex flex-col gap-1.5 text-slate-500">Zone Name (Cloudflare)
                        <input v-model="form.rotate.zone_name" placeholder="2233006.xyz">
                    </label>
                    <label class="flex flex-col gap-1.5 text-slate-500">Record Name (DNS Prefix)
                        <input v-model="form.rotate.record_name" placeholder="transitnodeawjp">
                    </label>
                </div>
                <div class="flex gap-4 mt-8">
                    <button @click="hideModal" class="flex-1 p-4 bg-slate-800 rounded-2xl">取消</button>
                    <button @click="submitRotate" :disabled="rotateLoading"
                        class="flex-1 p-4 bg-amber-600 hover:bg-amber-500 rounded-2xl font-bold disabled:opacity-50">
                        {{ rotateLoading ? '正在执行...' : '确认执行' }}
                    </button>
                </div>
            </div>
        </div>

        <!-- Add Mapping Modal -->
        <div v-if="modal.type === 'mapping'"
            class="fixed inset-0 bg-black/80 backdrop-blur-sm z-50 flex items-center justify-center p-4">
            <div class="glass w-full max-w-md p-8 rounded-[3rem] animate-in zoom-in-95 duration-200">
                <h3 class="text-2xl font-bold mb-6 text-indigo-400">{{ form.mapping.id ? '编辑分流规则' : '新增分流规则' }}</h3>
                <div class="space-y-4 text-sm">
                    <label class="flex flex-col gap-1.5 text-slate-500">选择入站入口
                        <select v-model.number="form.mapping.entry_node_id">
                            <option v-for="e in entries" :value="e.id">{{e.name}} (#{{e.id}})</option>
                        </select>
                    </label>
                    <label class="flex flex-col gap-1.5 text-slate-500">V2B 节点 ID
                        <input type="number" v-model.number="form.mapping.v2board_node_id" placeholder="21">
                    </label>
                    <label class="flex flex-col gap-1.5 text-slate-500">目标落地出口
                        <select v-model.number="form.mapping.target_exit_id">
                            <option v-for="ex in exits" :value="ex.id">{{ex.name}} (#{{ex.id}})</option>
                        </select>
                    </label>
                    <label class="flex flex-col gap-1.5 text-slate-500">独立监听端口 <span
                            class="text-xs text-slate-600">(留空则用入口默认端口)</span>
                        <input type="number" v-model.number="form.mapping.port" placeholder="4434">
                    </label>
                    <label class="flex flex-col gap-1.5 text-slate-500">节点协议
                        <select v-model="form.mapping.v2board_type">
                            <option value="v2ray">V2ray</option>
                            <option value="vless">VLESS</option>
                            <option value="shadowsocks">Shadowsocks</option>
                            <option value="anytls">AnyTLS</option>
                        </select>
                    </label>
                </div>
                <div class="flex gap-4 mt-8">
                    <button @click="hideModal" class="flex-1 p-4 bg-slate-800 rounded-2xl">取消</button>
                    <button @click="submitMapping" class="flex-1 p-4 bg-indigo-600 rounded-2xl font-bold">{{
                        form.mapping.id ? '保存修改' : '立即创建' }}</button>
                </div>
            </div>
        </div>

        <!-- Add Exit/Rule Modal (Simplified placeholders for consistency) -->
        <div v-if="modal.type === 'exit' || modal.type === 'rule'"
            class="fixed inset-0 bg-black/80 backdrop-blur-sm z-50 flex items-center justify-center">
            <div class="glass w-full max-w-md p-8 rounded-[3rem]">
                <h3 class="text-2xl font-bold mb-6">{{ modal.type === 'exit' ? '新增落地机' : '手动链路配置' }}</h3>
                <div class="space-y-4 text-sm" v-if="modal.type === 'exit'">
                    <label class="flex flex-col gap-1 text-slate-500">落地机备注名称<input v-model="form.exit.name"
                            placeholder="香港落地 01"></label>
                    <div class="flex gap-2">
                        <label class="flex-1 flex flex-col gap-1 text-slate-500">落地机地址<input v-model="form.exit.server"
                                placeholder="1.2.3.4"></label>
                        <label class="w-24 flex flex-col gap-1 text-slate-500">端口<input type="number"
                                v-model.number="form.exit.server_port" placeholder="443"></label>
                    </div>
                    <label class="flex flex-col gap-1 text-slate-500">传输协议
                        <select v-model="form.exit.protocol">
                            <option value="ss">Shadowsocks (传统/2022)</option>
                            <option value="vless">VLESS (XTLS-Vision)</option>
                            <option value="socks">Standard SOCKS5</option>
                        </select>
                    </label>
                    <!-- SS 专用加密方式 -->
                    <label v-if="form.exit.protocol === 'ss'" class="flex flex-col gap-1 text-slate-500">加密方式
                        (Cipher/Method)
                        <select v-model="form.exit.method">
                            <option value="2022-blake3-aes-128-gcm">2022-blake3-aes-128-gcm (SS-2022 推荐)</option>
                            <option value="2022-blake3-aes-256-gcm">2022-blake3-aes-256-gcm (SS-2022 高强)</option>
                            <option value="2022-blake3-chacha20-poly1305">2022-blake3-chacha20-poly1305</option>
                            <option value="aes-128-gcm">aes-128-gcm (AEAD)</option>
                            <option value="aes-192-gcm">aes-192-gcm (AEAD)</option>
                            <option value="aes-256-gcm">aes-256-gcm (AEAD)</option>
                            <option value="chacha20-ietf-poly1305">chacha20-ietf-poly1305 (AEAD)</option>
                            <option value="xchacha20-ietf-poly1305">xchacha20-ietf-poly1305 (AEAD)</option>
                            <option value="none">none (不推荐)</option>
                        </select>
                    </label>
                    <label class="flex flex-col gap-1 text-slate-500">{{ form.exit.protocol === 'ss' ? '连接密码 (Password)'
                        : 'UUID / 凭据' }}
                        <input v-model="form.exit.password" placeholder="填写对应的密钥内容">
                    </label>
                </div>
                <div class="space-y-4 text-sm" v-if="modal.type === 'rule'">
                    <label class="flex flex-col gap-1 text-slate-500">用户备注 / Email<input v-model="form.rule.user_email"
                            placeholder="v2b-user-01"></label>
                    <label class="flex flex-col gap-1 text-slate-500">VLESS UUID<input v-model="form.rule.user_id"
                            placeholder="用户 UUID"></label>
                    <div class="grid grid-cols-2 gap-2 mt-2">
                        <label class="flex flex-col gap-1 text-slate-500 text-xs">入口节点
                            <select v-model.number="form.rule.entry_node_id">
                                <option v-for="e in entries" :value="e.id">{{e.name}}</option>
                            </select>
                        </label>
                        <label class="flex flex-col gap-1 text-slate-500 text-xs">落地节点
                            <select v-model.number="form.rule.exit_node_id">
                                <option v-for="ex in exits" :value="ex.id">{{ex.name}}</option>
                            </select>
                        </label>
                    </div>
                </div>
                <div class="flex gap-4 mt-8">
                    <button @click="hideModal" class="flex-1 p-4 bg-slate-800 rounded-2xl">取消</button>
                    <button @click="modal.type === 'exit' ? submitExit() : submitRule()"
                        class="flex-1 p-4 bg-indigo-600 rounded-2xl font-bold">保存</button>
                </div>
            </div>
        </div>

        <!-- Cloud Provision Modal -->
        <div v-if="modal.type === 'provision'"
            class="fixed inset-0 bg-black/80 backdrop-blur-sm z-50 flex items-center justify-center p-4">
            <div class="glass w-full max-w-md p-8 rounded-[3rem] animate-in zoom-in-95 duration-200">
                <div class="flex gap-4 mb-6 border-b border-white/5 pb-2">
                    <button @click="provTab='create'"
                        :class="['pb-2 font-bold transition', provTab==='create' ? 'text-amber-500 border-b-2 border-amber-500' : 'text-slate-500']">新建节点</button>
                    <button @click="provTab='destroy'"
                        :class="['pb-2 font-bold transition', provTab==='destroy' ? 'text-rose-500 border-b-2 border-rose-500' : 'text-slate-500']">销毁/管理</button>
                </div>

                <!-- Tab: Create -->
                <div v-if="provTab==='create'">
                    <div class="mb-4 flex gap-4">
                        <div class="flex-1 p-3 rounded-xl border-2 cursor-pointer transition-all text-center"
                            :class="platform==='ec2'?'border-amber-500 bg-amber-500/10 text-amber-500 font-bold':'border-slate-700 text-slate-500'"
                            @click="platform='ec2'; fetchRegions()">
                            EC2 (专业版)
                        </div>
                        <div class="flex-1 p-3 rounded-xl border-2 cursor-pointer transition-all text-center"
                            :class="platform==='lightsail'?'border-purple-500 bg-purple-500/10 text-purple-500 font-bold':'border-slate-700 text-slate-500'"
                            @click="platform='lightsail'; fetchRegions()">
                            Lightsail (光帆)
                        </div>
                    </div>

                    <!-- EC2 Form -->
                    <div v-if="platform==='ec2'"
                        class="space-y-4 text-sm animate-in fade-in slide-in-from-right-4 duration-300">
                        <label class="flex flex-col gap-1.5 text-slate-500">机房区域 (EC2 Regions)
                            <select v-model="form.provision.region" @change="fetchImages" :disabled="regionsLoading">
                                <option disabled value="">{{ regionsLoading ? '正在加载可用区域...' : '请选择区域' }}</option>
                                <option v-for="r in availableRegions" :key="r" :value="r">{{ r }}</option>
                            </select>
                        </label>
                        <label class="flex flex-col gap-1.5 text-slate-500">实例配置 (EC2 Instance)
                            <select v-model="form.provision.instance_type">
                                <option value="t3.nano">t3.nano (0.5G) - 测试</option>
                                <option value="t3.micro">t3.micro (1G) - 入门</option>
                                <option value="t3.small">t3.small (2G) - 推荐</option>
                                <option value="t3.medium">t3.medium (4G) - 高性能</option>
                                <option value="c5.large">c5.large - 计算型</option>
                            </select>
                        </label>
                        <label class="flex flex-col gap-1.5 text-slate-500">操作系统 (AMI)
                            <select v-model="form.provision.image_id"
                                :disabled="imagesLoading || !form.provision.region">
                                <option disabled value="">{{ imagesLoading ? '正在搜索可用镜像...' : (form.provision.region ?
                                    '请选择系统' : '请先选择区域') }}</option>
                                <option v-for="img in availableImages" :key="img.id" :value="img.id">{{ img.name }} ({{
                                    img.id }})</option>
                            </select>
                        </label>
                    </div>

                    <!-- Lightsail Form -->
                    <div v-if="platform==='lightsail'"
                        class="space-y-4 text-sm animate-in fade-in slide-in-from-right-4 duration-300">
                        <label class="flex flex-col gap-1.5 text-slate-500">机房区域 (Lightsail Regions)
                            <select v-model="form.lightsail.region" @change="fetchImages" :disabled="regionsLoading">
                                <option disabled value="">{{ regionsLoading ? 'Loading Regions...' : 'Please Select
                                    Region' }}</option>
                                <option v-for="r in availableRegions" :key="r" :value="r">{{ r }}</option>
                            </select>
                        </label>
                        <label class="flex flex-col gap-1.5 text-slate-500">套餐选择 (Bundle / Plan)
                            <select v-model="form.lightsail.bundle_id" :disabled="imagesLoading">
                                <option disabled value="">{{ imagesLoading ? 'Loading Plans...' : 'Select Plan' }}
                                </option>
                                <option v-for="b in lsBundles" :key="b.id" :value="b.id">
                                    ${{ b.price }}/mo - {{ b.ram_size }}GB RAM - {{ b.cpu_count }}vCPU -
                                    {{b.transfer}}GB Traffic
                                </option>
                            </select>
                        </label>
                        <label class="flex flex-col gap-1.5 text-slate-500">操作系统 (Blueprint)
                            <select v-model="form.lightsail.blueprint_id" :disabled="imagesLoading">
                                <option disabled value="">{{ imagesLoading ? 'Loading OS...' : 'Select OS' }}</option>
                                <option v-for="bp in lsBlueprints" :key="bp.id" :value="bp.id">{{ bp.name }}</option>
                            </select>
                        </label>
                    </div>

                    <div class="mt-4 p-3 rounded-xl border"
                        :class="platform==='ec2'?'bg-amber-500/10 border-amber-500/20':'bg-purple-500/10 border-purple-500/20'">
                        <label class="flex flex-col gap-1.5 text-slate-500 font-bold"
                            :class="platform==='ec2'?'text-amber-500':'text-purple-500'">Root 密码 (SSH)
                            <input v-model="platform==='ec2'?form.provision.root_password:form.lightsail.root_password"
                                type="text" placeholder="Stealth123!@#" class="font-mono text-center">
                        </label>
                        <p class="text-[10px] opacity-70 mt-1 text-center">
                            {{ platform==='ec2' ? '* 本地会保存一份备用 SSH 密钥 (store/keys/)' : '* Lightsail 会自动附加 Static IP (免费) 并全放行端口' }}
                        </p>
                    </div>

                    <div class="flex gap-4 mt-8">
                        <button @click="hideModal" class="flex-1 p-4 bg-slate-800 rounded-2xl">取消</button>
                        <button @click="submitProvision" :disabled="provisionLoading"
                            :class="['flex-1 p-4 text-white rounded-2xl font-bold disabled:opacity-50', platform==='ec2'?'bg-gradient-to-r from-amber-500 to-orange-600':'bg-gradient-to-r from-purple-500 to-indigo-600']">
                            {{ provisionLoading ? '购买中 (Processing)...' : '立即开通 (Deploy)' }}
                        </button>
                    </div>
                </div>

                <!-- Tab: Cleanup & Keys -->
                <div v-if="provTab==='destroy'">
                    <!-- Key Management Section -->
                    <div class="mb-6">
                        <h4 class="text-indigo-400 font-bold mb-2 flex justify-between items-center">
                            备用密钥管理 (Safety Net)
                            <button @click="fetchKeys"
                                class="text-[10px] bg-slate-800 px-2 py-1 rounded hover:bg-slate-700">刷新列表</button>
                        </h4>
                        <div
                            class="bg-slate-900/50 rounded-xl border border-white/5 overflow-hidden max-h-32 overflow-y-auto custom-scrollbar">
                            <div v-if="keys.length === 0" class="p-4 text-center text-xs text-slate-600 italic">暂无本地密钥文件
                            </div>
                            <div v-for="k in keys" :key="k.name"
                                class="flex justify-between items-center p-2 px-3 hover:bg-white/5 border-b border-white/5 last:border-0">
                                <div>
                                    <div class="text-xs font-mono text-slate-300">{{k.name}}</div>
                                    <div class="text-[8px] text-slate-600">{{k.updated_at}} | {{k.size}} B</div>
                                </div>
                                <a :href="'/api/v1/cloud/keys/'+k.name" target="_blank"
                                    class="text-emerald-500 hover:text-emerald-400 p-1.5 bg-emerald-500/10 rounded-lg">
                                    <svg class="w-3 h-3" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                            d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4" />
                                    </svg>
                                </a>
                            </div>
                        </div>
                    </div>

                    <div class="bg-rose-500/10 p-4 rounded-2xl border border-rose-500/20 mb-4">
                        <h4 class="text-rose-400 font-bold mb-1">危险操作区</h4>
                        <p class="text-xs text-rose-300/80">请输入实例 ID 以彻底销毁云端机器。此操作不可逆。</p>
                    </div>
                    <div class="space-y-4 text-sm">
                        <label class="flex flex-col gap-1.5 text-slate-500">目标区域
                            <select v-model="form.provision.region">
                                <option value="ap-northeast-1">ToKyo (东京)</option>
                                <option value="ap-east-1">Hong Kong (香港)</option>
                                <option value="ap-southeast-1">Singapore (新加坡)</option>
                                <option value="us-west-1">California (加利福尼亚)</option>
                            </select>
                        </label>
                        <label class="flex flex-col gap-1.5 text-slate-500">实例 ID (Instance ID)
                            <input v-model="form.provision.destroy_id" placeholder="i-0abcd1234efgh5678"
                                class="font-mono">
                        </label>
                    </div>
                    <div class="flex gap-4 mt-6">
                        <button @click="hideModal" class="flex-1 p-4 bg-slate-800 rounded-2xl">取消</button>
                        <button v-if="platform==='lightsail'" @click="submitRotateIP"
                            :disabled="provisionLoading || !form.provision.destroy_id"
                            class="flex-1 p-4 bg-indigo-600 hover:bg-indigo-500 text-white rounded-2xl font-bold disabled:opacity-50">
                            {{ provisionLoading ? '处理中...' : '更换 IP (Rotate)' }}
                        </button>
                        <button @click="submitTerminate" :disabled="provisionLoading || !form.provision.destroy_id"
                            class="flex-1 p-4 bg-rose-600 hover:bg-rose-500 text-white rounded-2xl font-bold disabled:opacity-50">
                            {{ provisionLoading ? '销毁中...' : '确认销毁' }}
                        </button>
                    </div>
                </div>

            </div>
        </div>
    </div>


    <script>
        const { createApp } = Vue
        createApp({
            data() {
                return {
                    activeTab: 'dashboard',
                    provTab: 'create',
                    showDashboard: true,
                    isAuthenticated: false,
                    loginPassword: '',
                    loginError: '',
                    entries: [],
                    exits: [],
                    rules: [],
                    mappings: [],
                    keys: [],
                    availableRegions: [],
                    availableImages: [], // EC2
                    lsBundles: [], // Lightsail Bundles
                    lsBlueprints: [], // Lightsail OS
                    regionsLoading: false,
                    imagesLoading: false,
                    platform: 'ec2', // 'ec2' or 'lightsail'
                    trafficStats: {},
                    settings: {},
                    certLoading: false,
                    rotateLoading: false,
                    provisionLoading: false,
                    modal: { type: null },
                    form: {
                        entry: { id: null, name: '', port: 443, domain: '', certificate: '', key: '', fallback: '127.0.0.1:80', target_exit_id: 0, v2board_url: '', v2board_key: '', v2board_node_id: null, v2board_type: 'v2ray' },
                        exit: { id: null, name: '', protocol: 'ss', server: '', server_port: null, password: '', method: '2022-blake3-aes-128-gcm' },
                        rule: { id: null, user_email: '', user_id: '', entry_node_id: null, exit_node_id: null },
                        mapping: { id: null, entry_node_id: null, v2board_node_id: null, target_exit_id: null, v2board_type: 'v2ray', port: null },
                        rotate: { node_id: null, region: '', instance_id: '', zone_name: '', record_name: '' },
                        provision: { region: 'ap-northeast-1', instance_type: 't3.micro', image_id: '', root_password: '', destroy_id: '' },
                        lightsail: { region: '', bundle_id: '', blueprint_id: '', root_password: '' }
                    }
                }
            },
            mounted() { this.checkAuth(); },
            watch: {
                activeTab(newVal) {
                    if (newVal === 'settings') this.fetchSettings();
                },
                provTab(newVal) {
                    if (newVal === 'destroy') this.fetchKeys();
                }
            },
            methods: {
                checkAuth() {
                    const token = localStorage.getItem('stealth_token');
                    if (token) {
                        this.isAuthenticated = true;
                        this.fetchData();
                    } else {
                        this.isAuthenticated = false;
                    }
                },
                async performLogin() {
                    try {
                        const res = await fetch('/api/v1/auth/login', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ username: 'admin', password: this.loginPassword })
                        }).then(r => { if (!r.ok) throw new Error('Auth failed'); return r.json() });

                        localStorage.setItem('stealth_token', res.token);
                        this.isAuthenticated = true;
                        this.loginError = '';
                        this.fetchData();
                    } catch (e) {
                        this.loginError = 'Invalid Password';
                    }
                },
                logout() {
                    localStorage.removeItem('stealth_token');
                    this.isAuthenticated = false;
                    this.loginPassword = '';
                    this.entries = [];
                    this.exits = [];
                    this.rules = [];
                },
                async fetchData() {
                    if (!this.isAuthenticated) return;
                    const headers = { 'Authorization': localStorage.getItem('stealth_token') || '' };
                    try {
                        const responses = await Promise.all([
                            fetch('/api/v1/entries', { headers }),
                            fetch('/api/v1/exits', { headers }),
                            fetch('/api/v1/rules', { headers }),
                            fetch('/api/v1/mappings', { headers }),
                            fetch('/api/v1/traffic', { headers })
                        ]);

                        // Check for 401 on any request
                        for (const r of responses) {
                            if (r.status === 401) {
                                console.warn('Unauthorized, forcing logout');
                                this.logout();
                                return;
                            }
                        }

                        const [e, x, r, m, t] = await Promise.all(responses.map(res => res.json()));
                        this.entries = e; this.exits = x; this.rules = r; this.mappings = m; this.trafficStats = t || {};
                    } catch (err) { console.error('Data fail', err) }
                },
                async fetchSettings() {
                    const res = await this.apiGet('/api/v1/system/config');
                    if (res.config) this.settings = res.config;
                },
                async fetchKeys() {
                    try {
                        const res = await this.apiGet('/api/v1/cloud/keys');
                        this.keys = res || [];
                    } catch (e) {
                        console.error(e);
                    }
                },
                async saveSettings() {
                    await this.apiPost('/api/v1/system/config', this.settings);
                    alert('Configuration Saved');
                },
                showModal(type) { this.modal.type = type; },
                hideModal() { this.modal.type = null },

                // --- Rotate IP Logic ---
                showRotateModal(node) {
                    // Try to guess defaults or load from somewhere?
                    // For now, we rely on Settings for Region, but InstanceID is specific.
                    // If we stored InstanceID in EntryNode (future work), load it here.
                    this.form.rotate = {
                        node_id: node.id,
                        region: this.settings['aws.default_region'] || 'ap-northeast-1',
                        instance_id: localStorage.getItem(`node_${node.id}_instance_id`) || '', // Local cache helper
                        zone_name: this.settings['cloudflare.default_zone'] || '2233006.xyz',
                        record_name: node.domain ? node.domain.split('.')[0] : ''
                    };
                    this.showModal('rotate');
                },
                async submitRotate() {
                    if (!this.form.rotate.instance_id) return alert('Instance ID Required');
                    this.rotateLoading = true;
                    try {
                        // Cache instance ID locally for convenience
                        localStorage.setItem(`node_${this.form.rotate.node_id}_instance_id`, this.form.rotate.instance_id);

                        const res = await this.apiPost(`/api/v1/node/${this.form.rotate.node_id}/rotate-ip`, {
                            region: this.form.rotate.region,
                            instance_id: this.form.rotate.instance_id,
                            zone_name: this.form.rotate.zone_name,
                            record_name: this.form.rotate.record_name
                        });
                        alert('Success! New IP: ' + res.new_ip);
                        this.hideModal();
                        this.fetchData();
                    } catch (e) {
                        alert('Failed: ' + e);
                    } finally {
                        this.rotateLoading = false;
                    }
                },

                // --- Existing Methods ---
                async submitEntry() { await this.apiPost('/api/v1/entries', this.form.entry); this.hideModal(); this.fetchData(); },
                async submitExit() {
                    const cfg = {
                        server: this.form.exit.server,
                        server_port: this.form.exit.server_port,
                        method: this.form.exit.method
                    };
                    if (this.form.exit.protocol === 'ss') {
                        cfg.password = this.form.exit.password;
                        cfg.cipher = this.form.exit.method; // 冗余一份兼容旧逻辑
                    } else {
                        cfg.uuid = this.form.exit.password;
                    }
                    await this.apiPost('/api/v1/exits', { id: this.form.exit.id, name: this.form.exit.name, protocol: this.form.exit.protocol, config: JSON.stringify(cfg) });
                    this.hideModal(); this.fetchData();
                },
                async submitRule() { await this.apiPost('/api/v1/rules', this.form.rule); this.hideModal(); this.fetchData(); },
                async submitMapping() {
                    if (!this.form.mapping.v2board_node_id) return alert('请填入 V2Board 节点 ID (例如 21)');
                    if (!this.form.mapping.target_exit_id) return alert('请选择目标落地出口');

                    const payload = {
                        id: this.form.mapping.id, // Include ID for update
                        entry_node_id: parseInt(this.form.mapping.entry_node_id),
                        v2board_node_id: parseInt(this.form.mapping.v2board_node_id),
                        v2board_type: this.form.mapping.v2board_type || 'v2ray',
                        target_exit_id: parseInt(this.form.mapping.target_exit_id),
                        port: this.form.mapping.port || 0
                    };

                    const url = '/api/v1/mappings' + (this.form.mapping.id ? '/' + this.form.mapping.id : '');
                    const method = this.form.mapping.id ? 'PUT' : 'POST';

                    await fetch(url, {
                        method: method,
                        body: JSON.stringify(payload),
                        headers: { 'Content-Type': 'application/json', 'Authorization': localStorage.getItem('stealth_token') || '' }
                    });

                    this.hideModal();
                    this.fetchData();
                },
                async requestCert() {
                    if (!this.form.entry.domain) return alert('域名不能为空');
                    this.certLoading = true;
                    try {
                        const res = await this.apiPost('/api/v1/entries/issue-cert', { domain: this.form.entry.domain });
                        if (res.message) {
                            alert(res.message);
                            this.form.entry.cert_task = true; // 本地立即显示处理中
                            this.fetchData(); // 刷新获取最新节点状态
                        }
                    } finally { this.certLoading = false; }
                },
                async apiGet(url) {
                    const res = await fetch(url, { headers: { 'Authorization': localStorage.getItem('stealth_token') || '' } });
                    if (!res.ok) {
                        const err = await res.json().catch(() => ({}));
                        throw new Error(err.error || res.statusText);
                    }
                    return res.json();
                },
                async apiPost(url, data) {
                    const res = await fetch(url, { method: 'POST', body: JSON.stringify(data), headers: { 'Content-Type': 'application/json', 'Authorization': localStorage.getItem('stealth_token') || '' } });
                    if (!res.ok) {
                        const err = await res.json().catch(() => ({}));
                        throw new Error(err.error || res.statusText);
                    }
                    return res.json();
                },
                async deleteItem(type, id) {
                    if (!confirm('确定删除?')) return;
                    await fetch(`/api/v1/${type}/${id}`, { method: 'DELETE', headers: { 'Authorization': localStorage.getItem('stealth_token') || '' } });
                    this.fetchData();
                },
                findNodeName(list, id) {
                    const n = this[list].find(i => i.id == id);
                    return n ? n.name : '';
                },
                editEntry(n) { this.form.entry = { ...n }; this.showModal('entry'); },
                editExit(n) {
                    this.form.exit = { ...n };
                    const c = JSON.parse(n.config);
                    this.form.exit.server = c.server;
                    this.form.exit.server_port = c.server_port;
                    this.form.exit.password = c.password || c.uuid;
                    this.form.exit.method = c.method || c.cipher || '2022-blake3-aes-128-gcm';
                    this.showModal('exit');
                },
                addEntry() {
                    this.form.entry = { id: null, name: '', port: 443, domain: '', certificate: '', key: '', fallback: '127.0.0.1:80', target_exit_id: 0, v2board_url: '', v2board_key: '', v2board_node_id: null, v2board_type: 'v2ray' };
                    this.showModal('entry');
                },
                addExit() {
                    this.form.exit = { id: null, name: '', protocol: 'ss', server: '', server_port: null, password: '', method: '2022-blake3-aes-128-gcm' };
                    this.showModal('exit');
                },
                addRule() {
                    this.form.rule = { id: null, user_email: '', user_id: '', entry_node_id: null, exit_node_id: null };
                    this.showModal('rule');
                },
                editMapping(m) {
                    this.form.mapping = { ...m };
                    this.showModal('mapping');
                },
                addMapping() {
                    this.form.mapping = {
                        id: null,
                        entry_node_id: this.entries.length > 0 ? this.entries[0].id : null,
                        v2board_node_id: null,
                        target_exit_id: this.exits.length > 0 ? this.exits[0].id : null,
                        v2board_type: 'v2ray',
                        port: null
                    };
                    this.showModal('mapping');
                },
                showProvisionModal() {
                    // Reset
                    this.platform = 'ec2';
                    this.form.provision = { region: '', instance_type: 't3.micro', image_id: '', root_password: '', destroy_id: '' };
                    this.form.lightsail = { region: '', bundle_id: '', blueprint_id: '', root_password: '' };
                    this.showModal('provision');
                    this.fetchRegions();
                },
                async fetchRegions() {
                    this.regionsLoading = true;
                    try { // Platform check
                        const url = this.platform === 'ec2' ? '/api/v1/cloud/regions' : '/api/v1/cloud/lightsail/regions';
                        const res = await this.apiGet(url);
                        this.availableRegions = res || [];
                        // Default
                        const def = this.availableRegions.includes('ap-northeast-1') ? 'ap-northeast-1' : (this.availableRegions.includes('us-east-1') ? 'us-east-1' : '');

                        if (def) {
                            if (this.platform === 'ec2') this.form.provision.region = def;
                            else this.form.lightsail.region = def;
                            this.fetchImages(); // Images/Bundles
                        }
                    } catch (e) { console.error(e); } finally { this.regionsLoading = false; }
                },
                async fetchImages() {
                    const region = this.platform === 'ec2' ? this.form.provision.region : this.form.lightsail.region;
                    if (!region) return;
                    this.imagesLoading = true;

                    if (this.platform === 'ec2') {
                        this.availableImages = [];
                        this.form.provision.image_id = '';
                        try {
                            const res = await this.apiGet(`/api/v1/cloud/images?region=${region}`);
                            this.availableImages = res || [];
                            const debian = this.availableImages.find(i => i.name.includes('Debian 12'));
                            if (debian) this.form.provision.image_id = debian.id;
                            else if (this.availableImages.length > 0) this.form.provision.image_id = this.availableImages[0].id;
                        } catch (e) { console.error(e); }
                    } else {
                        // Lightsail - Fetch Bundles & Blueprints
                        this.lsBundles = [];
                        this.lsBlueprints = [];
                        try {
                            const [bun, blu] = await Promise.all([
                                this.apiGet(`/api/v1/cloud/lightsail/bundles?region=${region}`),
                                this.apiGet(`/api/v1/cloud/lightsail/blueprints?region=${region}`)
                            ]);
                            this.lsBundles = bun || [];
                            this.lsBlueprints = blu || [];
                            // Defaults
                            if (this.lsBundles.length) this.form.lightsail.bundle_id = this.lsBundles[0].id;
                            const deb = this.lsBlueprints.find(b => b.name.toLowerCase().includes('debian 12'));
                            if (deb) this.form.lightsail.blueprint_id = deb.id;
                            else if (this.lsBlueprints.length) this.form.lightsail.blueprint_id = this.lsBlueprints[0].id;
                        } catch (e) { console.error(e); }
                    }
                    this.imagesLoading = false;
                },
                async submitProvision() {
                    if (this.platform === 'ec2') {
                        if (!this.form.provision.region) return alert('请选择区域');
                        if (!this.form.provision.image_id) return alert('请选择操作系统');
                        if (!this.form.provision.root_password) return alert('请设置 Root 密码');
                    } else {
                        if (!this.form.lightsail.region) return alert('请选择区域');
                        if (!this.form.lightsail.bundle_id) return alert('请选择套餐');
                        if (!this.form.lightsail.blueprint_id) return alert('请选择系统');
                        if (!this.form.lightsail.root_password) return alert('请设置 Root 密码');
                    }

                    this.provisionLoading = true;
                    try {
                        let res;
                        if (this.platform === 'ec2') {
                            res = await this.apiPost('/api/v1/cloud/instances', this.form.provision);
                            alert(`EC2 实例创建成功!\nID: ${res.instance_id}\nIP: ${res.public_ip}\n\n备用私钥已保存 (store/keys/)。`);
                        } else {
                            res = await this.apiPost('/api/v1/cloud/lightsail/instances', this.form.lightsail);
                            alert(`Lightsail 实例创建成功!\nName: ${res.instance_name}\nIP: ${res.public_ip}\nStatic IP 已自动附加。防火墙全端口已放行。`);
                        }
                        this.hideModal();
                    } catch (e) {
                        alert('Create Failed: ' + e.message);
                    } finally {
                        this.provisionLoading = false;
                    }
                },
                async submitTerminate() {
                    const id = this.form.provision.destroy_id; // Using same input for now
                    if (!id) return;
                    if (!confirm(`⚠️ 危险警告 ⚠️\n\n即将永久销毁: ${id}\n此操作不可逆！确定要继续吗？`)) return;

                    this.provisionLoading = true;
                    try {
                        const region = this.platform === 'ec2' ? this.form.provision.region : this.form.lightsail.region;
                        if (this.platform === 'ec2') {
                            await this.apiPost('/api/v1/cloud/instances/terminate', { region, instance_id: id });
                        } else {
                            await this.apiPost('/api/v1/cloud/lightsail/terminate', { region, instance_name: id });
                        }
                        alert('销毁指令已发送。');
                        this.hideModal();
                    } catch (e) {
                        alert('Terminate Failed: ' + e.message);
                    } finally {
                        this.provisionLoading = false;
                    }
                },
                async submitRotateIP() {
                    const id = this.form.provision.destroy_id;
                    if (!id) return;
                    if (!confirm(`即将为 ${id} 更换静态 IP。\n旧 IP 将被释放，短暂断网后绑定新 IP。\n确定继续吗？`)) return;

                    this.provisionLoading = true;
                    try {
                        const region = this.form.lightsail.region;
                        const res = await this.apiPost('/api/v1/cloud/lightsail/rotate-ip', { region, instance_name: id });
                        alert(`更换成功!\n新 IP: ${res.new_ip}\n请手动更新入站节点配置。`);
                        this.hideModal();
                    } catch (e) {
                        alert('Rotate Failed: ' + e.message);
                    } finally {
                        this.provisionLoading = false;
                    }
                },
                getEntryTraffic(entryId) {
                    // Sum traffic for all rules belonging to this entry
                    let total = 0;
                    // Find rules for this entry
                    const entryRules = this.rules.filter(r => r.entry_node_id === entryId);
                    entryRules.forEach(r => {
                        const s = this.trafficStats[r.user_email];
                        if (s) total += (s.upload + s.download);
                    });

                    // Also sum dynamic mappings traffic? 
                    // Mappings map V2Board Node ID -> Exit. 
                    // Traffic is reported by UserEmail (Tag). 
                    // If tag format is like 'n20-xxxxx', it belongs to V2Board Node 20.
                    // We need to map Entry -> Mappings -> V2Board Node IDs -> Tags(UserEmails).
                    // This is complex because we don't have the list of ALL user emails for a mapping easily here without scanning all stats.

                    // Allow scanning all trafficStats to see which one belongs to this entry?
                    // The tag `n20` refers to V2B Node ID 20.
                    // We know which V2B Node IDs are associated with this entry via Mappings or Entry's own ID.

                    const targetV2bNodeIds = new Set();
                    if (this.entries.find(e => e.id === entryId).v2board_node_id) {
                        targetV2bNodeIds.add(this.entries.find(e => e.id === entryId).v2board_node_id);
                    }
                    this.mappings.filter(m => m.entry_node_id === entryId).forEach(m => targetV2bNodeIds.add(m.v2board_node_id));

                    // Iterate all stats
                    for (const [tag, stat] of Object.entries(this.trafficStats)) {
                        // Tag format: n{NodeID}-{UUID} or just UUID
                        if (tag.startsWith('n')) {
                            const parts = tag.split('-');
                            const nodeId = parseInt(parts[0].substring(1));
                            if (targetV2bNodeIds.has(nodeId)) {
                                total += (stat.upload + stat.download);
                            }
                        }
                    }

                    return total;
                },
                getMappingTraffic(entryId, v2bNodeId) {
                    let total = 0;
                    for (const [tag, stat] of Object.entries(this.trafficStats)) {
                        // Exact match for node ID in tag
                        if (tag.startsWith('n' + v2bNodeId + '-')) {
                            // We also need to ensure it's from THIS entry?
                            // Tags are globally unique per V2Board Node.
                            // If multiple entries share same V2B Node ID, traffic is shared.
                            // Assuming unique V2B Node IDs per entry usually.
                            total += (stat.upload + stat.download);
                        }
                    }
                    return total;
                },
                formatBytes(bytes, decimals = 2) {
                    if (!+bytes) return '0 B';
                    const k = 1024;
                    const dm = decimals < 0 ? 0 : decimals;
                    const sizes = ['B', 'KB', 'MB', 'GB', 'TB', 'PB', 'EB', 'ZB', 'YB'];
                    const i = Math.floor(Math.log(bytes) / Math.log(k));
                    return `${parseFloat((bytes / Math.pow(k, i)).toFixed(dm))} ${sizes[i]}`;
                }
            }
        }).mount('#app')
    </script>
</body>

</html>